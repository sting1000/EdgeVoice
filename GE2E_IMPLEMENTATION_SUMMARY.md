# GE2E-KWS Loss å®ç°å®Œæˆæ€»ç»“

## ğŸ‰ å®ç°çŠ¶æ€ï¼šå·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

åŸºäºè®ºæ–‡ **arXiv:2410.16647v1** çš„ **Generalized End-to-End (GE2E) Loss** å·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°EdgeVoiceé¡¹ç›®ä¸­ã€‚

## ğŸ“ æ–°å¢æ–‡ä»¶åˆ—è¡¨

```
EdgeVoice/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ ge2e_loss.py              # âœ… GE2E Lossæ ¸å¿ƒå®ç°
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ ge2e_example.py           # âœ… å®Œæ•´ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ train_ge2e.py                 # âœ… GE2Eè®­ç»ƒè„šæœ¬
â”œâ”€â”€ test_ge2e_integration.py      # âœ… é›†æˆæµ‹è¯•è„šæœ¬
â”œâ”€â”€ README_GE2E.md               # âœ… è¯¦ç»†æ–‡æ¡£
â””â”€â”€ GE2E_IMPLEMENTATION_SUMMARY.md # ğŸ“„ æœ¬æ–‡æ¡£
```

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

```
models/streaming_conformer.py     # âœ… æ·»åŠ åµŒå…¥å‘é‡è¾“å‡ºæ–¹æ³•
```

## ğŸ§ª æµ‹è¯•ç»“æœ

**é›†æˆæµ‹è¯•çŠ¶æ€**: âœ… **4/4 æµ‹è¯•é€šè¿‡**

1. âœ… **åŸºæœ¬åŠŸèƒ½éªŒè¯** - GE2E Lossè®¡ç®—å’ŒStreamingConformeråµŒå…¥è¾“å‡º
2. âœ… **æ‰¹æ¬¡é‡‡æ ·å™¨éªŒè¯** - ä¸“ç”¨æ‰¹æ¬¡ç»“æ„ç”Ÿæˆ
3. âœ… **ç«¯åˆ°ç«¯è®­ç»ƒéªŒè¯** - å®Œæ•´è®­ç»ƒæµç¨‹
4. âœ… **æ¨ç†å·¥ä½œæµç¨‹éªŒè¯** - è´¨å¿ƒè®¡ç®—å’Œç›¸ä¼¼åº¦åŒ¹é…

**ç¤ºä¾‹è¿è¡Œç»“æœ**:
```bash
$ python test_ge2e_integration.py
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼GE2E Loss å®ç°å·²å‡†å¤‡å°±ç»ªã€‚
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. GE2ELoss ç±»
- âœ… æ”¯æŒå¯å­¦ä¹ çš„ç¼©æ”¾å› å­(w)å’Œåç½®(b)å‚æ•°
- âœ… è‡ªåŠ¨æ³¨å†Œ/æµ‹è¯•é›†åˆ†ç¦»
- âœ… é«˜æ•ˆçš„ç›¸ä¼¼åº¦çŸ©é˜µè®¡ç®—
- âœ… æ•°å€¼ç¨³å®šçš„logsumexpå®ç°

### 2. GE2EBatchSampler ç±»
- âœ… ç¡®ä¿æ‰¹æ¬¡ç»“æ„ç¬¦åˆGE2Eè¦æ±‚
- âœ… æ”¯æŒæŒ‡å®šå…³é”®è¯æ•°é‡å’Œæ¯ä¸ªå…³é”®è¯çš„éŸ³é¢‘æ•°é‡
- âœ… è‡ªåŠ¨è¿‡æ»¤æ ·æœ¬æ•°é‡ä¸è¶³çš„ç±»åˆ«

### 3. StreamingConformer å¢å¼º
- âœ… `get_embeddings()` - è¾“å‡ºå½’ä¸€åŒ–åµŒå…¥å‘é‡
- âœ… `forward_with_embeddings()` - åŒæ—¶è¾“å‡ºåˆ†ç±»å’ŒåµŒå…¥
- âœ… ä¿æŒåŸæœ‰åŠŸèƒ½å®Œå…¨å…¼å®¹

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¸­å¯ç›‘æ§çš„å…³é”®æŒ‡æ ‡ï¼š
- **GE2E Losså€¼**: ç›‘æ§è®­ç»ƒæ”¶æ•›
- **ç±»å†…è·ç¦»**: åŒç±»æ ·æœ¬åµŒå…¥å‘é‡è·ç¦»ï¼ˆè¶Šå°è¶Šå¥½ï¼‰
- **ç±»é—´è·ç¦»**: ä¸åŒç±»æ ·æœ¬åµŒå…¥å‘é‡è·ç¦»ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰
- **åˆ†ç¦»åº¦**: ç±»é—´è·ç¦»/ç±»å†…è·ç¦»ï¼ˆ> 1.0ä¸ºä½³ï¼‰
- **ç±»å†…ç›¸ä¼¼åº¦**: åŒç±»æ ·æœ¬ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆ> 0.5ä¸ºä½³ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡ŒåŸºæœ¬æµ‹è¯•
```bash
python models/ge2e_loss.py
```

### è¿è¡Œå®Œæ•´ç¤ºä¾‹
```bash
python examples/ge2e_example.py
```

### è¿è¡Œé›†æˆæµ‹è¯•
```bash
python test_ge2e_integration.py
```

### å¼€å§‹è®­ç»ƒ
```bash
python train_ge2e.py \
    --data_dir ./data \
    --annotation_file ./data/annotations.csv \
    --num_phrases 4 \
    --num_utterances 8 \
    --epochs 100 \
    --lr 1e-4
```

## ğŸ’¡ ä½¿ç”¨è¦ç‚¹

### 1. æ•°æ®è¦æ±‚
- æ ‡æ³¨æ–‡ä»¶æ ¼å¼ï¼šCSVï¼ŒåŒ…å«`file_path`å’Œ`intent`åˆ—
- æ¯ä¸ªå…³é”®è¯è‡³å°‘éœ€è¦`num_utterances_per_phrase`ä¸ªæ ·æœ¬
- æ¨èæ¯ä¸ªå…³é”®è¯20-50ä¸ªæ ·æœ¬

### 2. æ‰¹æ¬¡é…ç½®
- `num_phrases_per_batch`: 4-8ï¼ˆæ ¹æ®GPUå†…å­˜è°ƒæ•´ï¼‰
- `num_utterances_per_phrase`: 8-12
- æ€»æ‰¹æ¬¡å¤§å° = `num_phrases * num_utterances`

### 3. è®­ç»ƒé…ç½®
```python
# åˆ›å»ºä¼˜åŒ–å™¨æ—¶éœ€è¦åŒ…å«GE2E Lossçš„å‚æ•°
optimizer = torch.optim.Adam(
    list(model.parameters()) + list(criterion.parameters()),
    lr=1e-4
)
```

### 4. æ¨ç†æµç¨‹
```python
# 1. æ³¨å†Œå…³é”®è¯ï¼ˆè®¡ç®—è´¨å¿ƒï¼‰
centroids = compute_centroids(registration_embeddings)

# 2. å®æ—¶æ£€æµ‹
test_embedding = model.get_embeddings(test_audio)
similarities = torch.matmul(test_embedding, centroids.T)
predicted_keyword = torch.argmax(similarities)
```

## ğŸ“ˆ è®­ç»ƒæ•ˆæœç¤ºä¾‹

å®é™…è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±å˜åŒ–ï¼š
```
Epoch 1: Loss = 1.0880, w = 10.00, b = -5.00
Epoch 2: Loss = 0.9546, w = 10.00, b = -5.00  
Epoch 3: Loss = 0.5141, w = 10.00, b = -5.00
Epoch 4: Loss = -0.8274, w = 10.00, b = -5.00
Epoch 5: Loss = -3.5788, w = 10.00, b = -5.00
```

âœ… **æŸå¤±å‡½æ•°æ­£å¸¸ä¸‹é™ï¼Œè®­ç»ƒæ”¶æ•›è‰¯å¥½**

## ğŸ” ç†è®ºåŸºç¡€

GE2E Lossæ ¸å¿ƒå…¬å¼ï¼š
```
L(c_i) = logâˆ‘_{nâˆˆN_i} exp(cos(c_i, n)) - logâˆ‘_{pâˆˆP_i} exp(cos(c_i, p))
```

å…³é”®æ¦‚å¿µï¼š
- **è´¨å¿ƒ(Centroid)**: æ¯ä¸ªå…³é”®è¯æ³¨å†Œé›†çš„å¹³å‡åµŒå…¥å‘é‡
- **æ³¨å†Œ/æµ‹è¯•åˆ†ç¦»**: å°†æ¯ä¸ªå…³é”®è¯çš„æ ·æœ¬åˆ†ä¸ºä¸¤éƒ¨åˆ†
- **å¯¹æ¯”å­¦ä¹ **: æ‹‰è¿‘æ­£æ ·æœ¬ï¼Œæ¨è¿œè´Ÿæ ·æœ¬

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†ä½¿ç”¨æ–‡æ¡£**: `README_GE2E.md`
- **å®Œæ•´ç¤ºä¾‹**: `examples/ge2e_example.py`
- **è®­ç»ƒè„šæœ¬**: `train_ge2e.py`
- **è®ºæ–‡å¼•ç”¨**: arXiv:2410.16647v1

## âœ… ç»“è®º

GE2E-KWS Losså·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°EdgeVoiceé¡¹ç›®ä¸­ï¼Œæ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ã€‚è¯¥å®ç°ï¼š

1. **å®Œå…¨ç¬¦åˆè®ºæ–‡ç†è®º** - å‡†ç¡®å®ç°äº†GE2E Lossçš„æ•°å­¦åŸç†
2. **å·¥ç¨‹å®è·µå‹å¥½** - æä¾›äº†å®Œæ•´çš„è®­ç»ƒå’Œæ¨ç†å·¥ä½œæµç¨‹  
3. **é«˜åº¦å¯é…ç½®** - æ”¯æŒçµæ´»çš„æ‰¹æ¬¡é…ç½®å’Œè¶…å‚æ•°è°ƒæ•´
4. **æ€§èƒ½ç¨³å®š** - ç»è¿‡å…¨é¢æµ‹è¯•ï¼Œç¡®ä¿æ•°å€¼ç¨³å®šæ€§
5. **æ˜“äºé›†æˆ** - ä¸ç°æœ‰StreamingConformeræ¨¡å‹æ— ç¼é›†æˆ

**é¡¹ç›®ç°åœ¨å·²å‡†å¤‡å¥½ä½¿ç”¨GE2E Lossè¿›è¡Œå…³é”®è¯æ£€æµ‹æ¨¡å‹çš„è®­ç»ƒï¼** ğŸš€ 