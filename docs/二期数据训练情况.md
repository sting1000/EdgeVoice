# 数据情况：
=== EdgeVoice Speech Dataset Statistics Report ===

Total Samples: 951

Intent Distribution:

  TAKE_PHOTO_ONE: 262 (27.5%)

  START_RECORDING_ONE: 239 (25.1%)

  STOP_RECORDING_ONE: 230 (24.2%)

  CAPTURE_AND_DESCRIBE_ONE: 220 (23.1%)

Gender Distribution:

  Male: 911 (95.8%)

  Female: 40 (4.2%)

Environment Distribution:

  安静室内: 951 (100.0%)

Audio Length Statistics (seconds):

  mean: 2.27

  median: 2.18

  min: 0.83

  max: 5.50

  std: 0.72

File Integrity Check:

  Missing Files: 0



# 输出日志：

(stereo) har@5500-node37:/data1/suzhechen/EdgeVoice0329$ ./run_streaming_conformer.sh
清理特征缓存...
==============================================
开始训练优化后的流式Conformer模型
训练轮数: 30
批大小: 16
学习率: 1e-4
权重衰减: 0.001
特征维度: 60=60
流式参数: CHUNK=15, STEP=5, CACHE=60
==============================================

=== 流式Conformer训练配置 ===
数据目录: data
标注文件: data/split/train_annotations.csv
模型保存路径: saved_models/streaming_conformer.pt
隐藏层维度: 128
Conformer层数: 3
注意力头数: 8
卷积核大小: 15
训练轮数: 30
批大小: 16
学习率: 0.0001
使用MixUp: True
标签平滑: 0.15
渐进式训练: True
数据集分割 - 训练集: 684, 验证集: 76
使用标签平滑损失，平滑参数: 0.15
使用余弦退火学习率调度，T_max=30，eta_min=1e-06
启用渐进式长度训练，序列长度进度: [20, 30, 40, 60, 80, 100, None]

开始训练流式Conformer模型...
模型配置: 隐藏层=128, 层数=3, 头数=8
特征维度: 60, 卷积核大小: 15
训练样本数: 684, 验证样本数: 76
总训练轮数: 30

Epoch 1/30
当前序列长度: 20
当前学习率: 0.000100
训练中: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:04<00:00,  8.67it/s, loss=1.42, acc=25.5]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.98it/s]
训练损失: 1.4232, 训练准确率: 25.55%
验证损失: 1.3830, 验证准确率: 28.95%
验证准确率提升: 0.00% -> 28.95%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 2/30
当前序列长度: 30
当前学习率: 0.000100
训练中: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:04<00:00,  8.71it/s, loss=1.46, acc=23.7]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.78it/s]
训练损失: 1.4230, 训练准确率: 23.70%
验证损失: 1.3915, 验证准确率: 28.95%
验证准确率未提升，当前耐心: 1/8

Epoch 3/30
当前序列长度: 40
当前学习率: 0.000099
训练中: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:05<00:00,  8.17it/s, loss=1.38, acc=29.7]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.82it/s]
训练损失: 1.3840, 训练准确率: 29.72%
验证损失: 1.4010, 验证准确率: 28.95%
验证准确率未提升，当前耐心: 2/8

Epoch 4/30
当前序列长度: 60
当前学习率: 0.000098
训练中: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:05<00:00,  8.10it/s, loss=1.39, acc=28.7]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  2.06it/s]
训练损失: 1.3892, 训练准确率: 28.67%
验证损失: 1.3731, 验证准确率: 36.84%
验证准确率提升: 28.95% -> 36.84%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 5/30
当前序列长度: 80
当前学习率: 0.000096
训练中: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:05<00:00,  8.00it/s, loss=1.39, acc=37.8]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.85it/s]
训练损失: 1.3301, 训练准确率: 37.76%
验证损失: 1.3922, 验证准确率: 32.89%
验证准确率未提升，当前耐心: 1/8

Epoch 6/30
当前序列长度: 100
当前学习率: 0.000093
训练中: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:05<00:00,  7.67it/s, loss=1.33, acc=36]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.72it/s]
训练损失: 1.3268, 训练准确率: 36.00%
验证损失: 1.2772, 验证准确率: 42.11%
验证准确率提升: 36.84% -> 42.11%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 7/30
当前序列长度: 完整序列
当前学习率: 0.000091
训练中: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:11<00:00,  3.77it/s, loss=1.13, acc=60.5]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.67it/s]
训练损失: 1.1349, 训练准确率: 60.53%
验证损失: 0.9570, 验证准确率: 75.00%
验证准确率提升: 42.11% -> 75.00%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 8/30
当前序列长度: 完整序列
当前学习率: 0.000087
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:09<00:00,  4.50it/s, loss=0.868, acc=80.6]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.80it/s]
训练损失: 0.8680, 训练准确率: 80.61%
验证损失: 0.8493, 验证准确率: 81.58%
验证准确率提升: 75.00% -> 81.58%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 9/30
当前序列长度: 完整序列
当前学习率: 0.000084
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:09<00:00,  4.30it/s, loss=0.831, acc=84.3]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.68it/s]
训练损失: 0.8312, 训练准确率: 84.32%
验证损失: 0.7302, 验证准确率: 90.79%
验证准确率提升: 81.58% -> 90.79%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 10/30
当前序列长度: 完整序列
当前学习率: 0.000080
训练中: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.23it/s, loss=0.769, acc=89]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.76it/s]
训练损失: 0.7693, 训练准确率: 89.02%
验证损失: 0.6568, 验证准确率: 94.74%
验证准确率提升: 90.79% -> 94.74%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 11/30
当前序列长度: 完整序列
当前学习率: 0.000075
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.30it/s, loss=0.741, acc=92.8]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.82it/s]
训练损失: 0.7410, 训练准确率: 92.81%
验证损失: 0.6602, 验证准确率: 96.05%
验证准确率提升: 94.74% -> 96.05%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 12/30
当前序列长度: 完整序列
当前学习率: 0.000071
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.14it/s, loss=0.713, acc=93.8]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.81it/s]
训练损失: 0.7131, 训练准确率: 93.80%
验证损失: 0.6604, 验证准确率: 96.05%
验证准确率未提升，当前耐心: 1/8

Epoch 13/30
当前序列长度: 完整序列
当前学习率: 0.000066
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:09<00:00,  4.50it/s, loss=0.717, acc=94.7]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.75it/s]
训练损失: 0.7005, 训练准确率: 94.70%
验证损失: 0.6348, 验证准确率: 97.37%
验证准确率提升: 96.05% -> 97.37%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 14/30
当前序列长度: 完整序列
当前学习率: 0.000061
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:11<00:00,  3.80it/s, loss=0.753, acc=91.4]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.73it/s]
训练损失: 0.7530, 训练准确率: 91.40%
验证损失: 0.6421, 验证准确率: 96.05%
验证准确率未提升，当前耐心: 1/8

Epoch 15/30
当前序列长度: 完整序列
当前学习率: 0.000056
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.28it/s, loss=0.657, acc=97.5]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.84it/s]
训练损失: 0.6570, 训练准确率: 97.54%
验证损失: 0.6330, 验证准确率: 97.37%
验证准确率未提升，当前耐心: 2/8

Epoch 16/30
当前序列长度: 完整序列
当前学习率: 0.000051
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:09<00:00,  4.45it/s, loss=0.691, acc=95.4]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.88it/s]
训练损失: 0.6910, 训练准确率: 95.43%
验证损失: 0.6298, 验证准确率: 98.68%
验证准确率提升: 97.37% -> 98.68%
保存最佳模型到: saved_models/streaming_conformer.pt

Epoch 17/30
当前序列长度: 完整序列
当前学习率: 0.000045
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.29it/s, loss=0.699, acc=94.3]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.83it/s]
训练损失: 0.6995, 训练准确率: 94.31%
验证损失: 0.6175, 验证准确率: 98.68%
验证准确率未提升，当前耐心: 1/8

Epoch 18/30
当前序列长度: 完整序列
当前学习率: 0.000040
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.24it/s, loss=0.722, acc=93.2]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.83it/s]
训练损失: 0.7223, 训练准确率: 93.25%
验证损失: 0.6367, 验证准确率: 97.37%
验证准确率未提升，当前耐心: 2/8

Epoch 19/30
当前序列长度: 完整序列
当前学习率: 0.000035
训练中: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:11<00:00,  3.83it/s, loss=0.7, acc=94.9]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:03<00:00,  1.55it/s]
训练损失: 0.7002, 训练准确率: 94.86%
验证损失: 0.6188, 验证准确率: 98.68%
验证准确率未提升，当前耐心: 3/8

Epoch 20/30
当前序列长度: 完整序列
当前学习率: 0.000030
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.10it/s, loss=0.651, acc=97.7]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.82it/s]
训练损失: 0.6509, 训练准确率: 97.67%
验证损失: 0.6190, 验证准确率: 98.68%
验证准确率未提升，当前耐心: 4/8

Epoch 21/30
当前序列长度: 完整序列
当前学习率: 0.000026
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  3.95it/s, loss=0.689, acc=95.5]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.80it/s]
训练损失: 0.6888, 训练准确率: 95.47%
验证损失: 0.6179, 验证准确率: 97.37%
验证准确率未提升，当前耐心: 5/8

Epoch 22/30
当前序列长度: 完整序列
当前学习率: 0.000021
训练中: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.05it/s, loss=0.68, acc=96]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.82it/s]
训练损失: 0.6799, 训练准确率: 96.01%
验证损失: 0.6229, 验证准确率: 97.37%
验证准确率未提升，当前耐心: 6/8

Epoch 23/30
当前序列长度: 完整序列
当前学习率: 0.000017
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:11<00:00,  3.75it/s, loss=0.659, acc=96.9]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.70it/s]
训练损失: 0.6585, 训练准确率: 96.87%
验证损失: 0.6158, 验证准确率: 97.37%
验证准确率未提升，当前耐心: 7/8

Epoch 24/30
当前序列长度: 完整序列
当前学习率: 0.000014
训练中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 43/43 [00:10<00:00,  4.19it/s, loss=0.668, acc=96.3]
验证中: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:02<00:00,  1.86it/s]
训练损失: 0.6677, 训练准确率: 96.33%
验证损失: 0.6138, 验证准确率: 98.68%
验证准确率未提升，当前耐心: 8/8
早停: 8轮未提升，停止训练

训练完成! 总时间: 286.58秒
最佳验证准确率: 98.68%

=== 评估流式模型 ===
测试数据: data/split/test_annotations.csv
置信度阈值: 0.8
评估流式模型: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 96/96 [00:22<00:00,  4.25it/s]

流式评估结果:
准确率: 0.6458
平均潜伏期: 1.4490 秒
早停比例: 0.6354
平均预测变化次数: 2.24
平均最终置信度: 0.7374

分类报告:
                          precision    recall  f1-score   support

CAPTURE_AND_DESCRIBE_ONE       0.41      1.00      0.58        22
     START_RECORDING_ONE       1.00      0.12      0.22        24
      STOP_RECORDING_ONE       0.95      0.78      0.86        23
          TAKE_PHOTO_ONE       0.95      0.70      0.81        27

                accuracy                           0.65        96
               macro avg       0.83      0.65      0.62        96
            weighted avg       0.84      0.65      0.62        96

流式评估准确率: 0.6458

训练和评估完成!
==============================================
流式Conformer模型训练和评估成功!
模型保存路径: saved_models/streaming_conformer.pt
模型文件已成功创建
文件大小: 22M
开始导出ONNX模型...
usage: export_onnx.py [-h] --model_path MODEL_PATH [--model_type {fast,streaming}] [--onnx_save_path ONNX_SAVE_PATH] [--dynamic_axes]
export_onnx.py: error: unrecognized arguments: --onnx_path saved_models/streaming_conformer.onnx
==============================================
测试实时流式处理demo...
注意: 未找到默认测试音频文件，请准备测试文件或使用麦克风模式
可以后续手动测试：python real_time_streaming_demo.py --model_path saved_models/streaming_conformer.pt --use_mic --chunk_size 15
==============================================
所有任务完成!
