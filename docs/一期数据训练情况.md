# 数据情况：
=== EdgeVoice Speech Dataset Statistics Report ===

Total Samples: 951

Intent Distribution:

  TAKE_PHOTO_ONE: 262 (27.5%)

  START_RECORDING_ONE: 239 (25.1%)

  STOP_RECORDING_ONE: 230 (24.2%)

  CAPTURE_AND_DESCRIBE_ONE: 220 (23.1%)

Gender Distribution:

  Male: 911 (95.8%)

  Female: 40 (4.2%)

Environment Distribution:

  安静室内: 951 (100.0%)

Audio Length Statistics (seconds):

  mean: 2.27

  median: 2.18

  min: 0.83

  max: 5.50

  std: 0.72

File Integrity Check:

  Missing Files: 0


# 参数：
STREAMING_CHUNK_SIZE = 30  # 每次处理的帧数（10ms/帧）

MAX_CACHED_FRAMES = 30    # 最大缓存的历史帧数

STREAMING_STEP_SIZE = 15    # 流式处理的步长


# 输出日志：


(stereo) har@5500-node37:/data1/suzhechen/EdgeVoice0322$ ./run_streaming_train_eval.sh

清理特征缓存...

========================================

开始流式模型训练 (预训练 + 流式微调)

预训练轮数: 10

微调轮数: 20

总轮数: 30

========================================

训练模型类型: streaming

数据目录: data

标注文件: data/split/train_annotations.csv

模型保存路径: saved_models/streaming_model.pt

使用设备: cuda

阶段1: 完整音频预训练...

预训练 Epoch 1/10: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:04<00:00,  5.16it/s, loss=1.43, acc=27.9]

预训练 Epoch 1/10 - 损失: 1.4339, 准确率: 27.89%

预训练 Epoch 2/10: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  8.85it/s, loss=1.39, acc=37.9]

预训练 Epoch 2/10 - 损失: 1.3281, 准确率: 37.89%

预训练 Epoch 3/10: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  8.96it/s, loss=0.935, acc=55.1]

预训练 Epoch 3/10 - 损失: 0.9353, 准确率: 55.13%

预训练 Epoch 4/10: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  9.08it/s, loss=0.742, acc=66.8]

预训练 Epoch 4/10 - 损失: 0.7114, 准确率: 66.84%

预训练 Epoch 5/10: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  8.97it/s, loss=0.391, acc=84.3]

预训练 Epoch 5/10 - 损失: 0.3906, 准确率: 84.34%

预训练 Epoch 6/10: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  9.20it/s, loss=0.345, acc=86.7]

预训练 Epoch 6/10 - 损失: 0.3453, 准确率: 86.71%

预训练 Epoch 7/10: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  9.12it/s, loss=0.233, acc=92.2]

预训练 Epoch 7/10 - 损失: 0.2333, 准确率: 92.24%

预训练 Epoch 8/10: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  8.90it/s, loss=0.116, acc=97]

预训练 Epoch 8/10 - 损失: 0.1162, 准确率: 96.97%

预训练 Epoch 9/10: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  9.13it/s, loss=0.085, acc=97.8]

预训练 Epoch 9/10 - 损失: 0.0814, 准确率: 97.76%

预训练 Epoch 10/10: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:02<00:00,  8.85it/s, loss=0.0628, acc=98.4]

预训练 Epoch 10/10 - 损失: 0.0628, 准确率: 98.42%

预训练模型已保存到: saved_models/streaming_model.pt_pretrained.pt

阶段2: 流式微调...

微调 Epoch 1/20 - 使用特征抖动 0.0400

微调 Epoch 1/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.03s/it, loss=4.14, acc=23.8, lr=3.33e-5]

微调 Epoch 1/20 - 损失: 4.1433, 准确率: 23.82%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 2/20 - 使用特征抖动 0.0379

微调 Epoch 2/20: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.02s/it, loss=3.39, acc=25, lr=6.67e-5]

微调 Epoch 2/20 - 损失: 3.3945, 准确率: 25.00%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 3/20 - 使用特征抖动 0.0357

微调 Epoch 3/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=2.38, acc=27.5, lr=0.0001]

微调 Epoch 3/20 - 损失: 2.3799, 准确率: 27.50%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 4/20 - 使用特征抖动 0.0336

微调 Epoch 4/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.62, acc=27.1, lr=0.0001]

微调 Epoch 4/20 - 损失: 1.6174, 准确率: 27.11%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 5/20 - 使用特征抖动 0.0314

微调 Epoch 5/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:25<00:00,  1.04s/it, loss=1.53, acc=26.4, lr=0.0001]

微调 Epoch 5/20 - 损失: 1.5275, 准确率: 26.45%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 6/20 - 使用特征抖动 0.0293

微调 Epoch 6/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:23<00:00,  1.01it/s, loss=1.42, acc=25.5, lr=0.0001]

微调 Epoch 6/20 - 损失: 1.4203, 准确率: 25.53%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 7/20 - 使用特征抖动 0.0271

微调 Epoch 7/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.00s/it, loss=1.42, acc=27.6, lr=0.0001]

微调 Epoch 7/20 - 损失: 1.4169, 准确率: 27.63%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 8/20 - 使用特征抖动 0.0250

微调 Epoch 8/20: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.00s/it, loss=1.4, acc=27.9, lr=0.0001]

微调 Epoch 8/20 - 损失: 1.4029, 准确率: 27.89%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 9/20 - 使用特征抖动 0.0229

微调 Epoch 9/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.41, acc=25.5, lr=0.0001]

微调 Epoch 9/20 - 损失: 1.4070, 准确率: 25.53%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 10/20 - 使用特征抖动 0.0207

微调 Epoch 10/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:23<00:00,  1.01it/s, loss=1.43, acc=26.1, lr=0.0001]

微调 Epoch 10/20 - 损失: 1.4263, 准确率: 26.05%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 11/20 - 使用特征抖动 0.0186

微调 Epoch 11/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.00s/it, loss=1.39, acc=27.6, lr=0.0001]

微调 Epoch 11/20 - 损失: 1.3927, 准确率: 27.63%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 12/20 - 使用特征抖动 0.0164

微调 Epoch 12/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.02s/it, loss=1.4, acc=28.2, lr=0.0001]

微调 Epoch 12/20 - 损失: 1.4045, 准确率: 28.16%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 13/20 - 使用特征抖动 0.0143

微调 Epoch 13/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.38, acc=27.8, lr=0.0001]

微调 Epoch 13/20 - 损失: 1.3751, 准确率: 27.76%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 14/20 - 使用特征抖动 0.0121

微调 Epoch 14/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:25<00:00,  1.08s/it, loss=1.45, acc=28.6, lr=0.0001]

微调 Epoch 14/20 - 损失: 1.3878, 准确率: 28.55%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 15/20 - 使用特征抖动 0.0100

微调 Epoch 15/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.4, acc=25.5, lr=0.0001]

微调 Epoch 15/20 - 损失: 1.4016, 准确率: 25.53%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 16/20 - 使用特征抖动 0.0100

微调 Epoch 16/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:26<00:00,  1.11s/it, loss=1.39, acc=28.2, lr=0.0001]

微调 Epoch 16/20 - 损失: 1.3875, 准确率: 28.16%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 17/20 - 使用特征抖动 0.0100

微调 Epoch 17/20: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.39, acc=27.5, lr=0.0001]

微调 Epoch 17/20 - 损失: 1.3913, 准确率: 27.50%

Epoch    17: reducing learning rate of group 0 to 7.0000e-05.

清除流式特征缓存，确保重新生成特征...

微调 Epoch 18/20 - 使用特征抖动 0.0100

微调 Epoch 18/20: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.4, acc=28, lr=7e-5]

微调 Epoch 18/20 - 损失: 1.4049, 准确率: 28.03%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 19/20 - 使用特征抖动 0.0100

微调 Epoch 19/20: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.01s/it, loss=1.39, acc=27.8, lr=7e-5]

微调 Epoch 19/20 - 损失: 1.3882, 准确率: 27.76%

清除流式特征缓存，确保重新生成特征...

微调 Epoch 20/20 - 使用特征抖动 0.0100

微调 Epoch 20/20: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 24/24 [00:24<00:00,  1.02s/it, loss=1.39, acc=27.8, lr=7e-5]

微调 Epoch 20/20 - 损失: 1.3946, 准确率: 27.76%

流式微调模型已保存到: saved_models/streaming_model.pt

开始导出模型为ONNX格式...

正在导出streaming模型到ONNX格式...

使用动态形状导出模型

检测到新的模型保存格式，包含标签映射和状态字典

模型包含 4 个意图类别: ['CAPTURE_AND_DESCRIBE_ONE', 'START_RECORDING_ONE', 'STOP_RECORDING_ONE', 'TAKE_PHOTO_ONE']

使用input_size=48创建模型

创建新的FastIntentClassifier实例，输入维度: 48，类别数: 4

加载模型权重

创建示例输入张量: torch.Size([1, 100, 48])

导出模型到 saved_models/streaming_model.onnx

模型已导出至: saved_models/streaming_model.onnx

导出模型的形状信息:

输入 'input': float32[1, 100, 48]

输出 'output': float32[1, 4]

训练完成！

========================================

流式模型训练成功!

模型保存路径: saved_models/streaming_model.pt

ONNX模型保存路径: saved_models/streaming_model.onnx

========================================

ONNX文件已成功创建

文件大小: 9.3M

开始评估流式模型...

使用设备: cuda

加载模型: saved_models/streaming_model.pt

识别类别: ['CAPTURE_AND_DESCRIBE_ONE', 'START_RECORDING_ONE', 'STOP_RECORDING_ONE', 'TAKE_PHOTO_ONE']

开始评估流式模型...

评估中: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 96/96 [00:17<00:00,  5.43it/s]

评估结果:

准确率: 0.5938

早停比例: 0.3646

从音频开始到决策的平均延迟: 1.6680 秒

从音频结束到决策的平均时间: -0.6620 秒 (负值表示在音频结束前已完成决策)

类别报告:

CAPTURE_AND_DESCRIBE_ONE: F1=0.6800, Precision=0.6071, Recall=0.7727

START_RECORDING_ONE: F1=0.2143, Precision=0.7500, Recall=0.1250

STOP_RECORDING_ONE: F1=0.6667, Precision=0.8125, Recall=0.5652

TAKE_PHOTO_ONE: F1=0.6400, Precision=0.5000, Recall=0.8889

macro avg: F1=0.5502, Precision=0.6674, Recall=0.5880

weighted avg: F1=0.5491, Precision=0.6619, Recall=0.5938

预测稳定性:

平均变化次数: 6.73

平均最终置信度: 0.6368

评估图表已保存为 streaming_metrics.png 和 streaming_confusion_matrix.png

预测稳定性分析已保存为 prediction_stability.png

========================================

测试实时流式处理demo...

注意: 未找到默认测试音频文件，且未启用麦克风，跳过实时demo测试

可以在后续手动测试：python real_time_streaming_demo.py --model_path saved_models/streaming_model.pt --use_mic

========================================

所有任务完成!